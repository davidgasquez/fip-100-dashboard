---
type LineChartProps = {
  data: Array<Record<string, string | number>>;
  x: string;
  y: string;
  label: string;
  yLabel?: string;
};

const { data, x, y, label, yLabel } = Astro.props as LineChartProps;

const points = data
  .map((row) => {
    const value = String(row[x]);
    return {
      x: new Date(value).getTime(),
      y: Number(row[y]),
      label: value,
    };
  })
  .filter((point) => Number.isFinite(point.x) && Number.isFinite(point.y))
  .sort((a, b) => a.x - b.x);

const payload = JSON.stringify(points);
const slugify = (value: string) =>
  value
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
const anchorId = slugify(label) || encodeURIComponent(label);
---

<section class="line-chart" id={anchorId}>
  <header class="chart-title">
    <a href={`#${anchorId}`}>{label}</a>
  </header>
  <figure class="chart-figure">
    <canvas
      role="img"
      aria-label={label}
      data-line-chart={payload}
      data-y-label={yLabel ?? ""}
    ></canvas>
  </figure>
</section>

<style>
  .line-chart {
    --line-accent: #0f172a;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin: 0;
  }

  .chart-title {
    margin: 0;
    font-weight: 600;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .chart-title a {
    color: inherit;
    text-decoration: none;
  }

  .chart-title a:hover {
    text-decoration: underline;
  }

  .chart-figure {
    margin: 0;
  }

  .chart-figure canvas {
    display: block;
    inline-size: 100%;
    aspect-ratio: 16 / 9;
    border: none;
    background: transparent;
  }
</style>

<script>
  import Chart from "chart.js/auto";
  import type { ScatterDataPoint, TooltipItem } from "chart.js";
  import annotationPlugin from "chartjs-plugin-annotation";
  import "chartjs-adapter-date-fns";

  Chart.register(annotationPlugin);

  type ChartPoint = ScatterDataPoint & { label: string };

  document
    .querySelectorAll<HTMLCanvasElement>("canvas[data-line-chart]")
    .forEach((canvas) => {
      const dataset = canvas.dataset.lineChart;
      if (!dataset) {
        throw new Error("Missing line chart payload");
      }

      const points = JSON.parse(dataset) as ChartPoint[];
      const label = canvas.ariaLabel ?? "";
      const strokeColor =
        getComputedStyle(canvas).getPropertyValue("--line-accent").trim() ||
        "#0f172a";
      const yLabel = canvas.dataset.yLabel?.trim() ?? "";

      new Chart(canvas, {
        type: "line",
        data: {
          datasets: [
            {
              label,
              data: points,
              pointRadius: 0,
              borderColor: strokeColor,
              borderWidth: 2,
              tension: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          normalized: true,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              intersect: false,
              mode: "index",
              callbacks: {
                title: ([first]: TooltipItem<"line">[]) =>
                  ((first?.raw as ChartPoint | undefined)?.label) ?? "",
              },
            },
            annotation: {
              annotations: {
                networkUpgradeV25: {
                  type: "line",
                  xMin: "2025-04-07",
                  xMax: "2025-04-07",
                  borderColor: "#d82124",
                  borderWidth: 1,
                  borderDash: [8, 8],
                  label: {
                    display: true,
                    content: "nv25",
                    rotation: 0,
                    backgroundColor: "white",
                    color: "#d82124",
                    font: { size: 12, weight: 600 },
                    padding: 0,
                    position: "start",
                    yAdjust: -10,
                  },
                },
              },
            },
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "month",
                tooltipFormat: "PPP",
                displayFormats: { month: "MMM yyyy" },
              },
              grid: { display: false },
              border: { color: strokeColor, width: 1 },
              ticks: { color: strokeColor },
            },
            y: {
              beginAtZero: true,
              grace: "5%",
              ticks: { precision: 0, color: strokeColor },
              border: { color: strokeColor, width: 1 },
              grid: { color: "rgba(15, 23, 42, 0.08)" },
              title: {
                display: Boolean(yLabel),
                text: yLabel,
                color: strokeColor,
                padding: { bottom: 4 },
                font: { weight: 600 },
              },
            },
          },
        },
      });
    });
</script>
