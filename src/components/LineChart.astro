---
type ChartDatum = Record<string, string | number>;

type ChartPoint = {
  x: number;
  y: number;
  label: string;
};

type LineChartProps = {
  data: ChartDatum[];
  x: string;
  y: string;
  label: string;
};

const { data, x, y, label } = Astro.props as LineChartProps;

const points: ChartPoint[] = data
  .map((row) => {
    const value = String(row[x]);
    return {
      x: new Date(value).getTime(),
      y: Number(row[y]),
      label: value,
    };
  })
  .sort((a, b) => a.x - b.x);

const payload = JSON.stringify(points);
---

<figure class="line-chart">
  <canvas role="img" aria-label={label} data-line-chart={payload}></canvas>
</figure>

<style>
  .line-chart {
    margin: 0;
    width: 100%;
    position: relative;
  }

  .line-chart canvas {
    display: block;
    width: 100%;
    max-width: 100%;
    height: auto;
  }
</style>

<script>
  import Chart from "chart.js/auto";
  import type { ScatterDataPoint, TooltipItem } from "chart.js";
  import annotationPlugin from "chartjs-plugin-annotation";
  import "chartjs-adapter-date-fns";

  Chart.register(annotationPlugin);

type ChartPoint = ScatterDataPoint & { label: string };

  const renderLineChart = (canvas: HTMLCanvasElement) => {
    const payload = canvas.dataset.lineChart;
    if (!payload) return;

    const points = JSON.parse(payload) as ChartPoint[];
    const label = canvas.getAttribute("aria-label") ?? "";

    new Chart(canvas, {
      type: "line",
      data: {
        datasets: [
          {
            label,
            data: points,
            pointRadius: 0,
            borderColor: "#000000",
          },
        ],
      },
      options: {
        responsive: true,
        animation: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            intersect: false,
            mode: "index",
            callbacks: {
              title: (items: TooltipItem<"line">[]) => {
                const raw = items[0]?.raw as ChartPoint | undefined;
                return raw?.label ?? "";
              },
            },
          },
          annotation: {
            annotations: {
              networkUpgradeV25: {
                type: "line",
                xMin: "2025-04-07",
                xMax: "2025-04-07",
                borderColor: "#d82124",
                borderWidth: 1,
                borderDash: [8, 8],
                label: {
                  display: true,
                  content: "nv25",
                  rotation: 0,
                  backgroundColor: "white",
                  color: "#d82124",
                  font: {
                    size: 12,
                    weight: 600,
                  },
                  padding: 0,
                  position: "start",
                  yAdjust: -10,
                },
              },
            },
          },
        },
        scales: {
          x: {
            type: "time",
            time: {
              unit: "month",
              displayFormats: {
                month: "MMM yyyy",
              },
            },
          },
          y: {
            beginAtZero: true,
          },
        },
      },
    });
  };

  const init = () => {
    document
      .querySelectorAll<HTMLCanvasElement>("canvas[data-line-chart]")
      .forEach(renderLineChart);
  };

  init();
</script>
